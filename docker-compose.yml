version: '3.8'

# ============================================
# GSC Warehouse - Unified Docker Compose
# ============================================
# Production-ready orchestration with resource limits
#
# Quick Start:
#   1. cp .env.example .env
#   2. Edit .env with your credentials
#   3. docker-compose up -d
#
# Profiles:
#   - core: Minimum viable (warehouse + ingestors)
#   - insights: Insight generation (engine + scheduler)
#   - api: Serving layer (API + MCP)
#   - intelligence: AI/ML features (Ollama + Redis + Celery)
#
# Note: Prometheus and Grafana are now always enabled (not optional)
#
# Usage:
#   docker-compose --profile core --profile insights up -d
#
# Resource Limits:
#   - All containers have memory/CPU limits
#   - Log rotation: 10MB max, 3 files
#   - Volume limits enforced
#   - Auto-cleanup policies enabled

services:
  # ==========================================
  # DATABASE (PostgreSQL)
  # ==========================================
  warehouse:
    image: postgres:14-alpine
    container_name: gsc_warehouse
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-gsc_db}
      POSTGRES_USER: ${POSTGRES_USER:-gsc_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-gsc_pass}
      PGDATA: /var/lib/postgresql/data/pgdata
      # Limit PostgreSQL memory usage
      POSTGRES_SHARED_BUFFERS: 512MB
      POSTGRES_WORK_MEM: 64MB
      POSTGRES_MAINTENANCE_WORK_MEM: 128MB
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./compose/init-db:/docker-entrypoint-initdb.d:ro
      - ./logs:/logs
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - gsc_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-gsc_user} -d ${POSTGRES_DB:-gsc_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    tmpfs:
      - /tmp:size=256M

  # ==========================================
  # STARTUP ORCHESTRATOR
  # ==========================================
  startup_orchestrator:
    build:
      context: .
      dockerfile: compose/dockerfiles/Dockerfile.scheduler
    container_name: gsc_startup
    environment:
      WAREHOUSE_DSN: postgresql://${POSTGRES_USER:-gsc_user}:${POSTGRES_PASSWORD:-gsc_pass}@warehouse:5432/${POSTGRES_DB:-gsc_db}
      BACKFILL_DAYS: ${BACKFILL_DAYS:-60}
    volumes:
      - ./logs:/logs
      - ./secrets:/secrets:ro
    networks:
      - gsc_network
    depends_on:
      warehouse:
        condition: service_healthy
    command: python /app/scheduler/startup_orchestrator.py
    profiles:
      - core
    restart: "no"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
    tmpfs:
      - /tmp:size=128M

  # ==========================================
  # INGESTORS
  # ==========================================
  api_ingestor:
    build:
      context: .
      dockerfile: compose/dockerfiles/Dockerfile.api_ingestor
    container_name: gsc_api_ingestor
    environment:
      WAREHOUSE_DSN: postgresql://${POSTGRES_USER:-gsc_user}:${POSTGRES_PASSWORD:-gsc_pass}@warehouse:5432/${POSTGRES_DB:-gsc_db}
      DB_HOST: warehouse
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB:-gsc_db}
      DB_USER: ${POSTGRES_USER:-gsc_user}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-gsc_pass}
      GSC_SVC_JSON: /secrets/gsc_sa.json
      GSC_INITIAL_BACKFILL_DAYS: 7
      PROPERTIES: ${GSC_PROPERTIES}
    volumes:
      - ./logs:/logs
      - ./secrets:/secrets:ro
    networks:
      - gsc_network
    depends_on:
      warehouse:
        condition: service_healthy
    profiles:
      - core
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    tmpfs:
      - /tmp:size=64M

  ga4_ingestor:
    build:
      context: .
      dockerfile: compose/dockerfiles/Dockerfile.ga4_ingestor
    container_name: gsc_ga4_ingestor
    environment:
      WAREHOUSE_DSN: postgresql://${POSTGRES_USER:-gsc_user}:${POSTGRES_PASSWORD:-gsc_pass}@warehouse:5432/${POSTGRES_DB:-gsc_db}
      GA4_CREDENTIALS_PATH: /secrets/gsc_sa.json
      GA4_PROPERTY_ID: ${GA4_PROPERTY_ID}
    volumes:
      - ./logs:/logs
      - ./secrets:/secrets:ro
    networks:
      - gsc_network
    depends_on:
      warehouse:
        condition: service_healthy
    profiles:
      - core
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    tmpfs:
      - /tmp:size=64M

  # ==========================================
  # TRANSFORM SERVICE
  # ==========================================
  transform:
    build:
      context: .
      dockerfile: compose/dockerfiles/Dockerfile.transformer
    container_name: gsc_transform
    environment:
      WAREHOUSE_DSN: postgresql://${POSTGRES_USER:-gsc_user}:${POSTGRES_PASSWORD:-gsc_pass}@warehouse:5432/${POSTGRES_DB:-gsc_db}
    volumes:
      - ./logs:/logs
      - ./transform/sql:/app/sql:ro
    networks:
      - gsc_network
    depends_on:
      startup_orchestrator:
        condition: service_completed_successfully
    command: python apply_transforms.py
    profiles:
      - disabled  # Disabled: transform script was moved, transforms handled manually
    restart: "no"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ==========================================
  # INSIGHTS ENGINE
  # ==========================================
  insights_engine:
    build:
      context: .
      dockerfile: compose/dockerfiles/Dockerfile.insights_engine
    container_name: gsc_insights_engine
    environment:
      WAREHOUSE_DSN: postgresql://${POSTGRES_USER:-gsc_user}:${POSTGRES_PASSWORD:-gsc_pass}@warehouse:5432/${POSTGRES_DB:-gsc_db}
      RISK_THRESHOLD_CLICKS_PCT: ${RISK_THRESHOLD_CLICKS_PCT:--20}
      RISK_THRESHOLD_CONVERSIONS_PCT: ${RISK_THRESHOLD_CONVERSIONS_PCT:--20}
      OPPORTUNITY_THRESHOLD_IMPRESSIONS_PCT: ${OPPORTUNITY_THRESHOLD_IMPRESSIONS_PCT:-50}
    volumes:
      - ./logs:/logs
    networks:
      - gsc_network
    depends_on:
      warehouse:
        condition: service_healthy
    command: python -m insights_core.cli refresh-insights
    profiles:
      - insights
    restart: "no"
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'

  # ==========================================
  # SCHEDULER
  # ==========================================
  scheduler:
    build:
      context: .
      dockerfile: compose/dockerfiles/Dockerfile.scheduler
    container_name: gsc_scheduler
    environment:
      WAREHOUSE_DSN: postgresql://${POSTGRES_USER:-gsc_user}:${POSTGRES_PASSWORD:-gsc_pass}@warehouse:5432/${POSTGRES_DB:-gsc_db}
      GSC_SVC_JSON: /secrets/gsc_sa.json
      GA4_CREDENTIALS_PATH: /secrets/gsc_sa.json
      PROPERTIES: ${GSC_PROPERTIES}
      SERPSTACK_API_KEY: ${SERPSTACK_API_KEY:-}
      PAGESPEED_API_KEY: ${PAGESPEED_API_KEY:-}
      DB_HOST: warehouse
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB:-gsc_db}
      DB_USER: ${POSTGRES_USER:-gsc_user}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-gsc_pass}
      # Hugo Content Integration
      HUGO_CONTENT_PATH: /hugo_content
      HUGO_FILE_LOCALIZATION_SUBDOMAINS: ${HUGO_FILE_LOCALIZATION_SUBDOMAINS:-}
      HUGO_DEFAULT_LOCALE: ${HUGO_DEFAULT_LOCALE:-en}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-mistral:latest}
    volumes:
      - ./logs:/logs
      - ./secrets:/secrets:ro
      - ${HUGO_CONTENT_PATH:-./hugo_content}:/hugo_content:rw
    networks:
      - gsc_network
    depends_on:
      insights_engine:
        condition: service_started
    profiles:
      - insights
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'

  # ==========================================
  # INSIGHTS API
  # ==========================================
  insights_api:
    build:
      context: .
      dockerfile: compose/dockerfiles/Dockerfile.insights_api
    container_name: gsc_insights_api
    environment:
      WAREHOUSE_DSN: postgresql://${POSTGRES_USER:-gsc_user}:${POSTGRES_PASSWORD:-gsc_pass}@warehouse:5432/${POSTGRES_DB:-gsc_db}
      API_PORT: ${API_PORT:-8000}
    volumes:
      - ./logs:/logs
    ports:
      - "${API_PORT:-8000}:8000"
    networks:
      - gsc_network
    depends_on:
      warehouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - api
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'

  # ==========================================
  # MCP SERVER
  # ==========================================
  mcp:
    build:
      context: .
      dockerfile: compose/dockerfiles/Dockerfile.mcp
    container_name: gsc_mcp
    environment:
      WAREHOUSE_DSN: postgresql://${POSTGRES_USER:-gsc_user}:${POSTGRES_PASSWORD:-gsc_pass}@warehouse:5432/${POSTGRES_DB:-gsc_db}
      MCP_PORT: ${MCP_PORT:-8001}
    volumes:
      - ./logs:/logs
    ports:
      - "${MCP_PORT:-8001}:8001"
    networks:
      - gsc_network
    depends_on:
      warehouse:
        condition: service_healthy
    profiles:
      - api
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ==========================================
  # OBSERVABILITY - PROMETHEUS (Required)
  # ==========================================
  prometheus:
    image: prom/prometheus:latest
    container_name: gsc_prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    networks:
      - gsc_network
    depends_on:
      warehouse:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ==========================================
  # OBSERVABILITY - GRAFANA (Required)
  # ==========================================
  grafana:
    image: grafana/grafana:latest
    container_name: gsc_grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: ${GRAFANA_PLUGINS:-}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    networks:
      - gsc_network
    depends_on:
      - prometheus
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ==========================================
  # METRICS EXPORTER (Required)
  # ==========================================
  metrics_exporter:
    build:
      context: .
      dockerfile: compose/dockerfiles/Dockerfile.metrics
    container_name: gsc_metrics_exporter
    environment:
      WAREHOUSE_DSN: postgresql://${POSTGRES_USER:-gsc_user}:${POSTGRES_PASSWORD:-gsc_pass}@warehouse:5432/${POSTGRES_DB:-gsc_db}
      METRICS_PORT: ${METRICS_PORT:-8002}
      EXPORTER_PORT: ${METRICS_PORT:-8002}
    volumes:
      - ./logs:/logs:ro
    ports:
      - "${METRICS_PORT:-8002}:8002"
    networks:
      - gsc_network
    depends_on:
      warehouse:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  # ==========================================
  # OLLAMA - LOCAL LLM SERVER
  # ==========================================
  ollama:
    image: ollama/ollama:latest
    container_name: gsc_ollama
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    networks:
      - gsc_network
    # Uncomment below if you have NVIDIA GPU
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - intelligence
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4.0'
        reservations:
          memory: 2G
          cpus: '2.0'

  # ==========================================
  # REDIS - TASK QUEUE & REAL-TIME STREAMS
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: gsc_redis
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - gsc_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - intelligence
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ==========================================
  # CELERY WORKER - ASYNC TASK PROCESSING
  # ==========================================
  celery_worker:
    build:
      context: .
      dockerfile: compose/dockerfiles/Dockerfile.celery
    container_name: gsc_celery_worker
    command: celery -A services.tasks worker --loglevel=info --concurrency=4
    environment:
      WAREHOUSE_DSN: postgresql://${POSTGRES_USER:-gsc_user}:${POSTGRES_PASSWORD:-gsc_pass}@warehouse:5432/${POSTGRES_DB:-gsc_db}
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      OLLAMA_URL: http://ollama:11434
    volumes:
      - ./logs:/logs
      - ./services:/app/services:ro
    networks:
      - gsc_network
    depends_on:
      redis:
        condition: service_healthy
      warehouse:
        condition: service_healthy
      ollama:
        condition: service_healthy
    profiles:
      - intelligence
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'

  # ==========================================
  # CADVISOR - CONTAINER METRICS
  # ==========================================
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: gsc_cadvisor
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    ports:
      - "8080:8080"
    networks:
      - gsc_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  # ==========================================
  # POSTGRES EXPORTER - DATABASE METRICS
  # ==========================================
  postgres_exporter:
    image: quay.io/prometheuscommunity/postgres-exporter:latest
    container_name: gsc_postgres_exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_USER:-gsc_user}:${POSTGRES_PASSWORD:-gsc_pass}@warehouse:5432/${POSTGRES_DB:-gsc_db}?sslmode=disable"
    ports:
      - "9187:9187"
    networks:
      - gsc_network
    depends_on:
      warehouse:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'

  # ==========================================
  # REDIS EXPORTER - CACHE & QUEUE METRICS
  # ==========================================
  redis_exporter:
    image: oliver006/redis_exporter:latest
    container_name: gsc_redis_exporter
    environment:
      REDIS_ADDR: "redis:6379"
    ports:
      - "9121:9121"
    networks:
      - gsc_network
    depends_on:
      redis:
        condition: service_healthy
    profiles:
      - intelligence
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'

# ==========================================
# NETWORKS
# ==========================================
networks:
  gsc_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# ==========================================
# VOLUMES
# ==========================================
volumes:
  pgdata:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  ollama_data:
    driver: local
  redis_data:
    driver: local

# MCP Server Insights Integration Guide

This guide shows how to integrate the Unified Insight Engine tools into the MCP server.

## Overview

The `mcp/insights_integration.py` module provides 5 new MCP tools for querying insights from the Unified Insight Engine. These tools allow Claude to access and analyze SEO insights directly through the MCP interface.

## Available Tools

1. **query_insights** - Query insights with flexible filters
2. **get_insight_by_id** - Retrieve a specific insight by ID
3. **get_actionable_insights** - Get high-priority actionable insights
4. **get_recent_insights** - Get insights from recent time period
5. **get_insights_summary** - Get aggregate statistics

## Integration Steps

### Step 1: Add Imports

Add these imports after the existing import statements in `mcp/mcp_server.py`:

```python
# Insights integration
try:
    from mcp.insights_integration import (
        initialize_insights_integration,
        get_insights_tool_schemas,
        call_insights_tool,
        INSIGHTS_AVAILABLE
    )
except ImportError:
    INSIGHTS_AVAILABLE = False
    initialize_insights_integration = None
    get_insights_tool_schemas = None
    call_insights_tool = None
```

### Step 2: Initialize Insights Repository

In the `main()` function or during server initialization, add:

```python
# Initialize insights repository (add after database connection setup)
insights_repository = None
if INSIGHTS_AVAILABLE and initialize_insights_integration:
    try:
        insights_repository = initialize_insights_integration(WAREHOUSE_DSN)
        if insights_repository:
            logger.info("Insights integration enabled")
        else:
            logger.warning("Insights integration disabled - repository initialization failed")
    except Exception as e:
        logger.warning(f"Failed to initialize insights integration: {e}")
        insights_repository = None
```

### Step 3: Register Tool Schemas

In the `get_tool_schemas()` function, add:

```python
# Add insights tool schemas if available
if INSIGHTS_AVAILABLE and get_insights_tool_schemas:
    try:
        insights_schemas = get_insights_tool_schemas()
        schemas.update(insights_schemas)
        logger.info(f"Added {len(insights_schemas)} insights tools")
    except Exception as e:
        logger.warning(f"Failed to load insights tool schemas: {e}")
```

### Step 4: Add Tool Call Handler

In the `call_tool()` function, add this handler before the default case:

```python
# Handle insights tools
if insights_repository and INSIGHTS_AVAILABLE and call_insights_tool:
    insights_tools = [
        'query_insights',
        'get_insight_by_id',
        'get_actionable_insights',
        'get_recent_insights',
        'get_insights_summary'
    ]

    if tool_name in insights_tools:
        try:
            result = call_insights_tool(tool_name, params, insights_repository)
            return result
        except Exception as e:
            logger.error(f"Error calling insights tool {tool_name}: {e}")
            return {
                "status": "error",
                "error": str(e)
            }
```

## Verification

After integration, verify the tools are available:

### 1. Start the MCP server

```bash
python mcp/mcp_server.py
```

### 2. Check the /tools endpoint

```bash
curl http://localhost:8001/tools
```

You should see 5 new tools listed:
- query_insights
- get_insight_by_id
- get_actionable_insights
- get_recent_insights
- get_insights_summary

### 3. Test a tool

```bash
curl -X POST http://localhost:8001/call-tool \
  -H "Content-Type: application/json" \
  -d '{"tool": "get_actionable_insights", "params": {"limit": 10}}'
```

## Alternative: Use Insights API Directly

If you prefer not to modify the MCP server, you can use the standalone Insights API instead:

### 1. Start the Insights API server

```bash
python insights_api/insights_api.py
```

### 2. Access HTTP endpoints

The API provides HTTP endpoints for all insight queries:

- `GET /api/insights` - Query insights with filters
- `GET /api/insights/actionable` - Get actionable insights
- `GET /api/insights/recent/{hours}` - Get recent insights
- `GET /api/insights/{id}` - Get specific insight
- `GET /api/insights/summary` - Get aggregate statistics

This allows accessing insights without modifying the MCP server.

## Troubleshooting

### Import Errors

If you see import errors, ensure:
- `insights_core` package is installed and accessible
- Database connection string (WAREHOUSE_DSN) is correct
- PostgreSQL is running and accessible

### No Insights Returned

If queries return no results:
- Check that the insights table has been created (`sql/11_insights_table.sql`)
- Verify insights are being generated by the Insight Engine
- Check database permissions for the user

### Tool Not Found

If the MCP server doesn't recognize the tools:
- Verify `get_insights_tool_schemas()` is being called in tool registration
- Check server logs for import or initialization errors
- Ensure `INSIGHTS_AVAILABLE` is `True`

## Architecture Notes

The insights integration uses:
- **insights_core/repository.py** - Data access layer for insights
- **insights_core/models.py** - Insight data models
- **mcp/insights_integration.py** - MCP tool interface layer

This separation allows the insights system to be used independently through:
- MCP tools (this integration)
- Insights API (standalone HTTP API)
- Direct Python imports (programmatic access)

## See Also

- [Insight Engine Guide](../analysis/INSIGHT_ENGINE_GUIDE.md)
- [MCP Server README](../../mcp/README.md)
- [Insights API Documentation](../../insights_api/README.md)

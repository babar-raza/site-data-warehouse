{
  "annotations": {"list": [{"builtIn": 1, "datasource": "-- Grafana --", "enable": true, "hide": true, "iconColor": "#3274D9", "name": "Annotations & Alerts", "type": "dashboard"}]},
  "description": "PostgreSQL database performance monitoring - connections, query latency, cache hits, and transaction rates",
  "title": "Database Performance",
  "uid": "database-performance",
  "version": 2,
  "timezone": "browser",
  "schemaVersion": 38,
  "refresh": "30s",
  "time": {"from": "now-1h", "to": "now"},
  "tags": ["prometheus", "database", "postgresql", "monitoring", "performance"],
  "links": [
    {"asDropdown": true, "icon": "external link", "includeVars": false, "keepTime": true, "tags": ["monitoring"], "targetBlank": true, "title": "Related Dashboards", "type": "dashboards"},
    {"icon": "dashboard", "title": "Service Health", "type": "link", "url": "/d/service-health", "targetBlank": true},
    {"icon": "dashboard", "title": "Infrastructure", "type": "link", "url": "/d/infrastructure-overview", "targetBlank": true}
  ],
  "panels": [
    {"id": 100, "title": "Connection Overview", "type": "row", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0}, "collapsed": false},
    {
      "id": 1, "title": "Active Connections", "description": "Current number of active database connections",
      "type": "stat", "gridPos": {"h": 4, "w": 6, "x": 0, "y": 1},
      "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(pg_stat_database_numbackends{datname!~\"template.*|postgres\"})", "refId": "A"}],
      "options": {"reduceOptions": {"values": false, "calcs": ["lastNotNull"]}, "colorMode": "value", "graphMode": "area", "textMode": "value_and_name"},
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#73BF69", "value": null}, {"color": "#FADE2A", "value": 50}, {"color": "#F2495C", "value": 80}]}}}
    },
    {
      "id": 2, "title": "Transactions/sec", "description": "Combined transaction rate (commits + rollbacks)",
      "type": "stat", "gridPos": {"h": 4, "w": 6, "x": 6, "y": 1},
      "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(pg_stat_database_xact_commit{datname!~\"template.*|postgres\"}[5m])) + sum(rate(pg_stat_database_xact_rollback{datname!~\"template.*|postgres\"}[5m]))", "refId": "A"}],
      "options": {"reduceOptions": {"values": false, "calcs": ["lastNotNull"]}, "colorMode": "value", "graphMode": "area"},
      "fieldConfig": {"defaults": {"unit": "ops", "color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#F2495C", "value": null}, {"color": "#FADE2A", "value": 10}, {"color": "#73BF69", "value": 50}]}}}
    },
    {
      "id": 3, "title": "Cache Hit Ratio", "description": "Database cache hit percentage - higher is better (target: >95%)",
      "type": "gauge", "gridPos": {"h": 4, "w": 6, "x": 12, "y": 1},
      "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(pg_stat_database_blks_hit{datname!~\"template.*|postgres\"}) / (sum(pg_stat_database_blks_hit{datname!~\"template.*|postgres\"}) + sum(pg_stat_database_blks_read{datname!~\"template.*|postgres\"})) * 100", "refId": "A"}],
      "options": {"reduceOptions": {"values": false, "calcs": ["lastNotNull"]}, "showThresholdLabels": false, "showThresholdMarkers": true},
      "fieldConfig": {"defaults": {"unit": "percent", "min": 0, "max": 100, "color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#F2495C", "value": null}, {"color": "#FADE2A", "value": 90}, {"color": "#73BF69", "value": 95}]}}}
    },
    {
      "id": 4, "title": "Database Size", "description": "Total size of all user databases",
      "type": "stat", "gridPos": {"h": 4, "w": 6, "x": 18, "y": 1},
      "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(pg_database_size_bytes{datname!~\"template.*|postgres\"})", "refId": "A"}],
      "options": {"reduceOptions": {"values": false, "calcs": ["lastNotNull"]}, "colorMode": "value", "graphMode": "area"},
      "fieldConfig": {"defaults": {"unit": "bytes", "color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#73BF69", "value": null}, {"color": "#FADE2A", "value": 10737418240}, {"color": "#F2495C", "value": 53687091200}]}}}
    },
    {"id": 101, "title": "Connection Details", "type": "row", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 5}, "collapsed": false},
    {
      "id": 5, "title": "Connections by Database", "description": "Active connections distributed by database",
      "type": "timeseries", "gridPos": {"h": 8, "w": 12, "x": 0, "y": 6},
      "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "pg_stat_database_numbackends{datname!~\"template.*|postgres\"}", "refId": "A", "legendFormat": "{{datname}}"}],
      "options": {"legend": {"displayMode": "table", "placement": "right", "showLegend": true, "calcs": ["lastNotNull", "max"]}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "fieldConfig": {"defaults": {"color": {"mode": "palette-classic"}, "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 10, "showPoints": "never"}}}
    },
    {
      "id": 6, "title": "Transaction Rate", "description": "Commits vs rollbacks per second",
      "type": "timeseries", "gridPos": {"h": 8, "w": 12, "x": 12, "y": 6},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(pg_stat_database_xact_commit{datname!~\"template.*|postgres\"}[5m]))", "refId": "A", "legendFormat": "Commits"},
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(pg_stat_database_xact_rollback{datname!~\"template.*|postgres\"}[5m]))", "refId": "B", "legendFormat": "Rollbacks"}
      ],
      "options": {"legend": {"displayMode": "table", "placement": "bottom", "showLegend": true, "calcs": ["lastNotNull", "sum"]}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "fieldConfig": {"defaults": {"unit": "ops", "color": {"mode": "palette-classic"}, "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 10, "showPoints": "never"}}}
    },
    {"id": 102, "title": "Query Performance", "type": "row", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 14}, "collapsed": false},
    {
      "id": 7, "title": "Rows Fetched vs Returned", "description": "Ratio indicates index efficiency",
      "type": "timeseries", "gridPos": {"h": 8, "w": 12, "x": 0, "y": 15},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(pg_stat_database_tup_fetched{datname!~\"template.*|postgres\"}[5m]))", "refId": "A", "legendFormat": "Fetched"},
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(pg_stat_database_tup_returned{datname!~\"template.*|postgres\"}[5m]))", "refId": "B", "legendFormat": "Returned"}
      ],
      "options": {"legend": {"displayMode": "table", "placement": "bottom", "showLegend": true, "calcs": ["lastNotNull", "mean"]}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "fieldConfig": {"defaults": {"unit": "ops", "color": {"mode": "palette-classic"}, "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 10, "showPoints": "never"}}}
    },
    {
      "id": 8, "title": "Rows Modified", "description": "Insert, update, delete operations per second",
      "type": "timeseries", "gridPos": {"h": 8, "w": 12, "x": 12, "y": 15},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(pg_stat_database_tup_inserted{datname!~\"template.*|postgres\"}[5m]))", "refId": "A", "legendFormat": "Inserts"},
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(pg_stat_database_tup_updated{datname!~\"template.*|postgres\"}[5m]))", "refId": "B", "legendFormat": "Updates"},
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(pg_stat_database_tup_deleted{datname!~\"template.*|postgres\"}[5m]))", "refId": "C", "legendFormat": "Deletes"}
      ],
      "options": {"legend": {"displayMode": "table", "placement": "bottom", "showLegend": true, "calcs": ["lastNotNull", "sum"]}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "fieldConfig": {"defaults": {"unit": "ops", "color": {"mode": "palette-classic"}, "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 10, "showPoints": "never"}}}
    },
    {"id": 103, "title": "Cache & Locks", "type": "row", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 23}, "collapsed": false},
    {
      "id": 9, "title": "Deadlocks", "description": "Deadlock rate - should be near zero",
      "type": "timeseries", "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
      "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(pg_stat_database_deadlocks{datname!~\"template.*|postgres\"}[5m]))", "refId": "A", "legendFormat": "Deadlocks/sec"}],
      "options": {"legend": {"displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "single"}},
      "fieldConfig": {"defaults": {"unit": "ops", "color": {"mode": "palette-classic"}, "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 10, "showPoints": "auto", "thresholdsStyle": {"mode": "area"}}, "thresholds": {"mode": "absolute", "steps": [{"color": "#73BF69", "value": null}, {"color": "#FADE2A", "value": 0.1}, {"color": "#F2495C", "value": 1}]}}}
    },
    {
      "id": 10, "title": "Disk Blocks Read vs Hit", "description": "Cache efficiency - hits should greatly exceed reads",
      "type": "timeseries", "gridPos": {"h": 8, "w": 12, "x": 12, "y": 24},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(pg_stat_database_blks_read{datname!~\"template.*|postgres\"}[5m]))", "refId": "A", "legendFormat": "Disk Reads"},
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(pg_stat_database_blks_hit{datname!~\"template.*|postgres\"}[5m]))", "refId": "B", "legendFormat": "Cache Hits"}
      ],
      "options": {"legend": {"displayMode": "table", "placement": "bottom", "showLegend": true, "calcs": ["lastNotNull", "mean"]}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "fieldConfig": {"defaults": {"unit": "ops", "color": {"mode": "palette-classic"}, "custom": {"drawStyle": "line", "lineInterpolation": "smooth", "fillOpacity": 10, "showPoints": "never"}}}
    },
    {"id": 104, "title": "Database Details", "type": "row", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 32}, "collapsed": false},
    {
      "id": 11, "title": "Database Statistics", "description": "Overview of all databases with key metrics",
      "type": "table", "gridPos": {"h": 8, "w": 24, "x": 0, "y": 33},
      "targets": [{"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "pg_stat_database_numbackends{datname!~\"template.*|postgres\"}", "refId": "A", "format": "table", "instant": true}],
      "options": {"showHeader": true, "sortBy": [{"displayName": "datname", "desc": false}], "cellHeight": "sm"},
      "fieldConfig": {"defaults": {"custom": {"align": "left", "displayMode": "auto", "filterable": true}}, "overrides": [{"matcher": {"id": "byName", "options": "Connections"}, "properties": [{"id": "custom.displayMode", "value": "gradient-gauge"}]}]},
      "transformations": [{"id": "organize", "options": {"excludeByName": {"Time": true, "job": true, "instance": true}, "indexByName": {"datname": 0, "Value": 1}, "renameByName": {"datname": "Database", "Value": "Connections"}}}]
    }
  ]
}
